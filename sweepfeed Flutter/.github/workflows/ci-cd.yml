name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  # Code Quality and Testing
  test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock', '**/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Get dependencies
      run: flutter pub get

    - name: Verify Flutter installation
      run: flutter doctor -v

    - name: Code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: Analyze code
      run: flutter analyze --fatal-infos

    - name: Check formatting
      run: dart format --set-exit-if-changed .

    - name: Run unit tests
      run: flutter test --coverage

    - name: Run widget tests
      run: flutter test test/features/ --coverage

    - name: Run security tests
      run: flutter test test/core/security/ --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

    - name: Security audit
      run: |
        dart pub deps --json | jq '.packages[] | select(.source == "hosted") | .name + "@" + .version' > dependencies.txt
        echo "Checking for known vulnerabilities..."
        # Add security vulnerability scanning here

  # Build for Android
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 45
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock', '**/gradle/wrapper/gradle-wrapper.properties') }}

    - name: Get dependencies
      run: flutter pub get

    - name: Code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: Create .env file
      run: |
        echo "FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}" >> .env
        echo "FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}" >> .env
        echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env

    - name: Setup Android signing
      if: github.event_name == 'release'
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > android/app/keystore.jks
        echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> android/key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
        echo "storeFile=keystore.jks" >> android/key.properties

    - name: Build Android APK (Debug)
      if: github.event_name == 'push'
      run: flutter build apk --debug --build-name="${{ github.run_number }}" --build-number="${{ github.run_number }}"

    - name: Build Android APK (Release)
      if: github.event_name == 'release'
      run: flutter build apk --release --build-name="${{ github.event.release.tag_name }}" --build-number="${{ github.run_number }}"

    - name: Build Android App Bundle (Release)
      if: github.event_name == 'release'
      run: flutter build appbundle --release --build-name="${{ github.event.release.tag_name }}" --build-number="${{ github.run_number }}"

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-*.apk
        retention-days: 30

    - name: Upload AAB artifact
      if: github.event_name == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 90

  # Build for iOS
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: test
    timeout-minutes: 60
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/Library/Caches/CocoaPods
        key: ${{ runner.os }}-flutter-ios-${{ hashFiles('**/pubspec.lock', '**/Podfile.lock') }}

    - name: Get dependencies
      run: flutter pub get

    - name: Code generation
      run: flutter packages pub run build_runner build --delete-conflicting-outputs

    - name: Create .env file
      run: |
        echo "FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}" >> .env
        echo "FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}" >> .env
        echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env

    - name: Setup iOS certificates
      if: github.event_name == 'release'
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        # Create certificates directory
        mkdir -p ~/certificates
        
        # Decode and install certificate
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > ~/certificates/certificate.p12
        security create-keychain -p "" build.keychain
        security import ~/certificates/certificate.p12 -k ~/build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security list-keychains -s ~/build.keychain
        security default-keychain -s ~/build.keychain
        security unlock-keychain -p "" ~/build.keychain
        security set-key-partition-list -S apple-tool:,apple: -s -k "" ~/build.keychain
        
        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

    - name: Install CocoaPods
      run: |
        cd ios
        pod install --repo-update

    - name: Build iOS (Debug)
      if: github.event_name == 'push'
      run: flutter build ios --debug --no-codesign --build-name="${{ github.run_number }}" --build-number="${{ github.run_number }}"

    - name: Build iOS (Release)
      if: github.event_name == 'release'
      run: flutter build ios --release --build-name="${{ github.event.release.tag_name }}" --build-number="${{ github.run_number }}"

    - name: Build IPA
      if: github.event_name == 'release'
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -destination generic/platform=iOS -archivePath Runner.xcarchive archive
        xcodebuild -exportArchive -archivePath Runner.xcarchive -exportPath ../build/ios/ipa -exportOptionsPlist ExportOptions.plist

    - name: Upload iOS artifact
      if: github.event_name == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: build/ios/ipa/*.ipa
        retention-days: 90

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 45
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/sdk
        key: ${{ runner.os }}-android-sdk-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: Nexus 6

    - name: Get dependencies
      run: flutter pub get

    - name: Start Firebase emulators
      run: |
        npm install -g firebase-tools
        firebase emulators:start --only firestore,auth --project demo-project &
        sleep 10

    - name: Run integration tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        ram-size: 4096M
        heap-size: 1024M
        script: |
          flutter drive --driver=test_driver/integration_test.dart --target=integration_test/app_test.dart

  # Deploy to Firebase App Distribution
  deploy-firebase:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Android APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: ./

    - name: Deploy to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: testers
        file: app-debug.apk
        releaseNotes: |
          Automated build from commit ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Build number: ${{ github.run_number }}

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.event_name == 'release'
    environment: production
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Android AAB
      uses: actions/download-artifact@v4
      with:
        name: android-aab
        path: ./android/

    - name: Download iOS IPA
      uses: actions/download-artifact@v4
      with:
        name: ios-ipa
        path: ./ios/

    - name: Setup Fastlane
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true

    - name: Install Fastlane
      run: |
        gem install fastlane

    - name: Deploy Android to Google Play
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
      run: |
        echo "$GOOGLE_PLAY_SERVICE_ACCOUNT" > google-play-service-account.json
        fastlane supply --aab android/app-release.aab --track production --release_status completed --skip_upload_metadata --skip_upload_images --skip_upload_screenshots

    - name: Deploy iOS to App Store
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        fastlane deliver --ipa ios/*.ipa --skip_metadata --skip_screenshots --automatic_release false

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: dart

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  # Performance Testing
  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}

    - name: Get dependencies
      run: flutter pub get

    - name: Run performance tests
      run: flutter test test/performance/ --reporter json > performance-results.json

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: performance-results.json
        retention-days: 30

  # Notify on completion
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [test, build-android, build-ios]
    if: always()
    timeout-minutes: 5

    steps:
    - name: Notify Slack on Success
      if: needs.test.result == 'success' && needs.build-android.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#sweepfeed-ci'
        text: |
          ✅ SweepFeed CI/CD Pipeline Completed Successfully!
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Build: ${{ github.run_number }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on Failure
      if: needs.test.result == 'failure' || needs.build-android.result == 'failure' || needs.build-ios.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#sweepfeed-ci'
        text: |
          ❌ SweepFeed CI/CD Pipeline Failed!
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Build: ${{ github.run_number }}
          Check the logs for details.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}