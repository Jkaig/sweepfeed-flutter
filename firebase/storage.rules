rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('roles.admin', false) == true;
    }
    
    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isValidFileSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    function isValidFileName(fileName) {
      return fileName.size() > 0 && fileName.size() <= 100;
    }
    
    // ============================================
    // CONTEST IMAGES
    // ============================================
    
    match /contests/{imageId} {
      allow read: if true; // Public read
      allow write: if isAdmin() && 
        isValidImageType() &&
        isValidFileSize(10) &&
        isValidFileName(imageId); // Max 10MB
    }
    
    // ============================================
    // USER PROFILE PICTURES
    // ============================================
    
    match /user_profile_pictures/{userId}/{fileName} {
      allow read: if true; // Public read
      allow write: if isOwner(userId) && 
        isValidImageType() &&
        isValidFileSize(5) && // Max 5MB
        isValidFileName(fileName) &&
        fileName.matches('.*\\.(jpg|jpeg|png|gif|webp)$');
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    match /users/{userId}/profile_picture.jpg {
      allow read: if true; // Public read
      allow write: if isOwner(userId) && 
        isValidImageType() &&
        isValidFileSize(5); // Max 5MB
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    match /profiles/{userId}/{imageId} {
      allow read: if true; // Public read
      allow write: if isOwner(userId) && 
        isValidImageType() &&
        isValidFileSize(5) && // Max 5MB
        isValidFileName(imageId);
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // VERIFICATION DOCUMENTS
    // ============================================
    
    match /verification_documents/{winnerId}/{fileName} {
      allow read: if isAdmin() || 
        (isAuthenticated() && 
         exists(/databases/$(database)/documents/winners/{winnerId}) &&
         get(/databases/$(database)/documents/winners/{winnerId}).data.userId == request.auth.uid);
      allow write: if isAuthenticated() && 
        exists(/databases/$(database)/documents/winners/{winnerId}) &&
        get(/databases/$(database)/documents/winners/{winnerId}).data.userId == request.auth.uid &&
        (request.resource.contentType.matches('image/.*') || 
         request.resource.contentType.matches('application/pdf')) &&
        isValidFileSize(10) && // Max 10MB
        isValidFileName(fileName);
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ENTRY RECEIPTS & DOCUMENTS
    // ============================================
    
    match /entry_receipts/{userId}/{receiptId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) && 
        (request.resource.contentType.matches('image/.*') || 
         request.resource.contentType.matches('application/pdf')) &&
        isValidFileSize(5) && // Max 5MB
        isValidFileName(receiptId);
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
